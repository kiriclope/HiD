#+STARTUP: fold
#+PROPERTY: header-args:ipython :results both :exports both :async yes :session calcium :kernel dual_data

* Notebook Settings

#+begin_src ipython
%load_ext autoreload
%autoreload 2
%reload_ext autoreload

%run /home/leon/dual_task/dual_data/notebooks/setup.py
%matplotlib inline
%config InlineBackend.figure_format = 'png'
#+end_src

#+RESULTS:
:RESULTS:
: The autoreload extension is already loaded. To reload it, use:
:   %reload_ext autoreload
: Python exe
: /home/leon/mambaforge/envs/dual_data/bin/python
: <Figure size 700x432.624 with 0 Axes>
:END:

* Imports

#+begin_src ipython
  import sys
  sys.path.insert(0, '/home/leon/dual_task/dual_data/')

  import pickle as pkl
  import numpy as np
  import matplotlib.pyplot as plt
  from scipy.stats import circmean
  from time import perf_counter

  import torch
  import torch.nn as nn
  import torch.optim as optim
  from skorch import NeuralNetClassifier

  from sklearn.base import clone
  from sklearn.model_selection import StratifiedKFold
  from sklearn.model_selection import cross_val_score, cross_validate
  from sklearn.ensemble import BaggingClassifier
  from sklearn.preprocessing import StandardScaler, RobustScaler
  from sklearn.pipeline import Pipeline
  from sklearn.model_selection import GridSearchCV, RandomizedSearchCV, RepeatedStratifiedKFold, StratifiedKFold

  import statsmodels.api as sm
  import statsmodels.formula.api as smf
  import pandas as pd

  from mne.decoding import SlidingEstimator, cross_val_multiscore, GeneralizingEstimator
  from src.decode.my_mne import my_cross_val_multiscore
  from mne.decoding import SlidingEstimator, get_coef

  from src.common.plot_utils import add_vlines, add_vdashed
  from src.attractor.energy import run_energy, plot_energy
  from src.common.options import set_options
  from src.stats.bootstrap import my_boots_ci
  from src.decode.bump import decode_bump, circcvl
  from src.common.get_data import get_X_y_days, get_X_y_S1_S2
  from src.preprocess.helpers import avg_epochs

  import torch.optim as optim
  from torch.utils.data import Dataset, TensorDataset, DataLoader
#+end_src

#+RESULTS:

* Helpers
** Statistics
#+begin_src ipython
  from scipy.stats import bootstrap

  def get_bootstrap_ci(data, statistic=np.mean, confidence_level=0.95, n_resamples=1000, random_state=None):
      result = bootstrap((data,), statistic)
      ci_lower, ci_upper = result.confidence_interval
      return ci_lower, ci_upper
#+end_src

#+RESULTS:
* Data
#+begin_src ipython
  from scipy.io import loadmat

  path = "/home/leon/dual_task/dual_data/data"
  mouse = "ACCM03"
  data = loadmat(path + "/" + mouse + "/SamedROI/" + mouse + "_all_days" + ".mat")
#+end_src

#+RESULTS:

#+begin_src ipython
  print(data.keys())
#+end_src

#+RESULTS:
:RESULTS:
dict_keys(['__header__', '__version__', '__globals__', 'FR_Trial', 'basFrame', 'blockPerDay', 'delayFrame', 'delayPeriodFrame', 'frameRate', 'laserTag', 'rewardFrame', 'sampleFrame', 'testFrame', 'trialPerBlock', 'dff_Mice', 'Cdf_Mice', 'Events', 'trialPerDay'])
:END:

#+begin_src ipython
  print(data['Events'].shape[0]/192)
#+end_src

#+RESULTS:
:RESULTS:
5.0
:END:

#+begin_src ipython
  print(data['blockPerDay'])
  print(data['trialPerBlock'])
  print(data['trialPerDay'])
#+end_src

#+RESULTS:
:RESULTS:
[[4]]
[[48]]
[[192]]
:END:

#+begin_src ipython
  print(data['dff_Mice'].shape)
#+end_src

#+RESULTS:
:RESULTS:
(361, 960, 84)
:END:

#+begin_src ipython
  print(data['Events'])
#+end_src

#+RESULTS:
:RESULTS:
[[17 12  3 ...  0  0  0]
 [18 12  1 ...  0  0  0]
 [17 11  1 ...  0  0  0]
 ...
 [17 11  1 ...  0  0  0]
 [18 11  4 ...  0  0  0]
 [17 12  4 ...  0  0  0]]
:END:

#+begin_src ipython
  print(np.sum(data['Events'][:, 4]==0))
#+end_src

#+RESULTS:
:RESULTS:
320
:END:

* Parameters

#+begin_src ipython
  DEVICE = 'cuda:1'
  mice = ['ChRM04','JawsM15', 'JawsM18', 'ACCM03', 'ACCM04']
  tasks = ['DPA', 'DualGo', 'DualNoGo']

  kwargs = {
      'mouse': 'JawsM15',
      'trials': '', 'reload': 1, 'data_type': 'dF', 'preprocess': True,
      'scaler_BL': None, 'avg_noise':True, 'unit_var_BL':False,
      'random_state': None, 'T_WINDOW': 0.0,
      'l1_ratio': 0.95, 'DCVL': 0
  }

  options = set_options(**kwargs)
#+end_src

#+RESULTS:

#+begin_src ipython
    X_days, y_days = get_X_y_days(**options)
    y_days['tasks'] = y_days['tasks'].astype('category')
    #  y_days = y_days[y_days['laser']==0]
    print('X', X_days.shape, 'y', y_days.shape)
    print(y_days.keys())
#+end_src

#+RESULTS:
#+begin_example
  Reading data from source file
  mouse JawsM15 n_days 6 day 1 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 2 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 3 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 4 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 5 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 6 type dF all data: X (192, 693, 84) y (9, 192)
  ##########################################
  PREPROCESSING: SCALER None AVG MEAN False AVG NOISE True UNIT VAR False
  ##########################################
  X (1152, 693, 84) y (1152, 6)
  Index(['sample_odor', 'test_odor', 'response', 'tasks', 'laser', 'day'], dtype='object')
#+end_example

* Activity timing

#+begin_src ipython
  day = 5
  options['day'] = day
  options['task'] = 'DualGo'
  options['T_WINDOW'] = 0.0

  X_data, y_data = get_X_y_S1_S2(X_days, y_days, **options)
  print('data', X_data.shape)

  size = X_data.shape[0] // 2
  X = X_data[:, :, options['bins_LD']].mean(0)
  print('X', X.shape)
  peak_times = np.argmax(X, axis=1)
  idx = np.argsort(peak_times)

  # options['epochs'] = ['LD']
  # X_avg = avg_epochs(X_data, **options).astype('float32').mean(0)
  # idx = np.argsort(X_avg)
  # print(idx.shape)
#+end_src

#+RESULTS:
: DATA: FEATURES sample TASK DualGo TRIALS  DAYS 5 LASER 0
: data (64, 361, 84)
: X (361, 9)

#+begin_src ipython
  fig, ax = plt.subplots(2, 3, figsize=0.75 * np.array([3 * width, 2 * height]))

  size = X_data.shape[0]

  for i in range(options['n_days'] // 2):
      options['day'] = i+1
      X_data, y_data = get_X_y_S1_S2(X_days, y_days, **options)

      data = circcvl(np.nanmean(X_data[:size, idx], 0), windowSize=2, axis=0)

      ax[0][i].imshow(data,
                      aspect='auto', cmap='viridis',
                      extent=[0, 14, 0, 693],
                      vmin=-0.5, vmax=1.0,
                      )

      add_vlines(ax=ax[0][i])
      add_vlines(ax=ax[0][i])
      add_vlines(ax=ax[0][i])

  for i in range(options['n_days'] // 2, options['n_days']):
      options['day'] = i+1
      X_data, y_data = get_X_y_S1_S2(X_days, y_days, **options)

      data = circcvl(np.nanmean(X_data[:size, idx], 0), windowSize=2, axis=0)
      ax[1][i-3].imshow(data,
                        aspect='auto', cmap='viridis',
                        extent=[0, 14, 0, 693],
                        vmin=-0.5, vmax=1.0,
                      )
      add_vlines(ax=ax[1][i-3])
      add_vlines(ax=ax[1][i-3])
      add_vlines(ax=ax[1][i-3])
  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
: DATA: FEATURES sample TASK DualGo TRIALS  DAYS 1 LASER 0
: DATA: FEATURES sample TASK DualGo TRIALS  DAYS 2 LASER 0
: DATA: FEATURES sample TASK DualGo TRIALS  DAYS 3 LASER 0
: DATA: FEATURES sample TASK DualGo TRIALS  DAYS 4 LASER 0
: DATA: FEATURES sample TASK DualGo TRIALS  DAYS 5 LASER 0
[[file:./.ob-jupyter/f3aa81ebfbc41c31fa5444e0079f314d04638bc9.png]]
:END:

#+begin_src ipython

#+end_src

#+RESULTS:

* GLM vs Days

#+begin_src ipython
    X_days, y_days = get_X_y_days(**options)
    y_days['tasks'] = y_days['tasks'].astype('category')
    #  y_days = y_days[y_days['laser']==0]
    print('X', X_days.shape, 'y', y_days.shape)
    print(y_days.keys())
#+end_src

#+RESULTS:
: Loading files from /home/leon/dual_task/dual_data/data/ACCM03
: ##########################################
: PREPROCESSING: SCALER standard AVG MEAN False AVG NOISE True UNIT VAR False
: ##########################################
: X (960, 361, 84) y (960, 6)
: Index(['sample_odor', 'test_odor', 'response', 'tasks', 'laser', 'day'], dtype='object')

#+begin_src ipython
  options['epochs'] = ['ED']
  X_avg = avg_epochs(X_days, **options).astype('float32')
  print('X_avg', X_avg.shape)
  #+end_src

#+RESULTS:
: X_avg (960, 361)

  #+begin_src ipython
    formula = 'df ~ sample_odor * tasks'
    options['task'] = 'DPA'

    results = []
    for day in range(1, options['n_days']+1):
            options['day'] = day
            X, y = get_X_y_S1_S2(X_avg, y_days, **options)
            res = []

            data = y_days[(y_days['day'] == day) & (y_days['laser']==0) & (y_days['tasks']=='DPA')]
            # print(data.shape)

            for neuron in range(1, X_avg.shape[1]):
                    data.loc[:, ['df']] = X[:, neuron]
                    glm_gauss = smf.glm(formula=formula, data=data, family=sm.families.Gaussian())
                    res.append(glm_gauss.fit())

            results.append(res)
#+end_src

#+RESULTS:
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 1 LASER 0
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 2 LASER 0
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 3 LASER 0
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 4 LASER 0
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 5 LASER 0

#+begin_src ipython
  results = np.array(results)
#+end_src

#+RESULTS:

#+begin_src ipython
  print(results[0][2].summary())
#+end_src

#+RESULTS:
#+begin_example
                   Generalized Linear Model Regression Results
  ==============================================================================
  Dep. Variable:                     df   No. Observations:                   64
  Model:                            GLM   Df Residuals:                       62
  Model Family:                Gaussian   Df Model:                            1
  Link Function:               Identity   Scale:                          5.3946
  Method:                          IRLS   Log-Likelihood:                -143.73
  Date:                Mon, 22 Jul 2024   Deviance:                       334.46
  Time:                        13:01:05   Pearson chi2:                     334.
  No. Iterations:                     3   Pseudo R-squ. (CS):           0.009346
  Covariance Type:            nonrobust
  =================================================================================================
                                      coef    std err          z      P>|z|      [0.025      0.975]
  -------------------------------------------------------------------------------------------------
  Intercept                         0.3405      0.411      0.829      0.407      -0.464       1.145
  tasks[T.DualGo]                        0          0        nan        nan           0           0
  tasks[T.DualNoGo]                      0          0        nan        nan           0           0
  sample_odor                      -0.4380      0.581     -0.754      0.451      -1.576       0.700
  sample_odor:tasks[T.DualGo]            0          0        nan        nan           0           0
  sample_odor:tasks[T.DualNoGo]          0          0        nan        nan           0           0
  =================================================================================================
#+end_example

  #+begin_src ipython
    selective = []
    beta = []
    for day in range(options['n_days']):
        sel = []
        bet = []
        for neuron in range(X_avg.shape[1]-1):
            p_value = results[day, neuron].pvalues['sample_odor']
            if p_value < 0.05:
                sel.append(neuron)
            bet.append(results[day, neuron].params['sample_odor'])
        selective.append(sel)
        beta.append(bet)
#+end_src

#+RESULTS:

#+begin_src ipython
  print(selective[0])
  print(selective[-1])
#+end_src

#+RESULTS:
: [19, 110, 113, 129, 134, 148, 154, 170, 210, 229, 244, 268, 306, 333, 341]
: [22, 79, 80, 104, 158, 227, 233, 252, 253, 265, 282, 290]

#+begin_src ipython
  sparse = []
  for i in range(options['n_days']):
      sparse.append(len(selective[i]))
  #+end_src

#+RESULTS:

#+begin_src ipython
  plt.plot(sparse)
#+end_src

#+RESULTS:
:RESULTS:
| <matplotlib.lines.Line2D | at | 0x7f0220323c90> |
[[file:./.ob-jupyter/b78490388854279e38e76d5bfd1dc5b8113d5a6f.png]]
:END:

#+begin_src ipython
  print(beta[0])
  print(beta[-1])
#+end_src

#+RESULTS:
:RESULTS:
# [goto error]
: ---------------------------------------------------------------------------
: IndexError                                Traceback (most recent call last)
: Cell In[135], line 1
: ----> 1 print(beta[0])
:       2 print(beta[-1])
:
: IndexError: list index out of range
:END:

#+begin_src ipython
  idx = np.array(beta[-1]).argsort()
  # print(np.array(beta[-1])[idx])
#+end_src

#+RESULTS:

#+begin_src ipython
  day = options['n_days']
  options['day'] = day
  fig, ax = plt.subplots(1, 2, figsize=[2*width, height])
  X_data, y_data = get_X_y_S1_S2(X_days, y_days, **options)
  print(X_data.shape)

  size = X_data.shape[0] // 2

  data = circcvl(np.nanmean(X_data[:size, idx], 0), windowSize=10, axis=0)

  ax[0].imshow(data,
            aspect='auto', cmap='jet',
            extent=[0, 14, 0, len(selective[day-1])],
            vmin=-0.5, vmax=1.5,
            interpolation='lanczos')

  data = circcvl(np.nanmean(X_data[size:, idx], 0), windowSize=10, axis=0)

  ax[1].imshow(data,
            aspect='auto', cmap='jet',
            extent=[0, 14, 0, len(selective[day-1])],
            vmin=-0.5, vmax=1.5,
            interpolation='lanczos')

  # add_vdashed(ax)
  # cb = ax.set_colorbar()
  # cb.set_label('$\Delta F / F$')

  ax[0].set_xticks(np.arange(0, 16, 4))
  ax[0].set_xlabel('Time')
  ax[0].set_ylabel('Neuron')

  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 5 LASER 0
: (64, 361, 84)
[[file:./.ob-jupyter/5e826e58a48536e59f48d5b0c7a35df223775132.png]]
:END:

#+begin_src ipython
  fig, ax = plt.subplots(2, 3, figsize=0.75 * np.array([3 * width, 2 * height]))

  size = X_data.shape[0]

  for i in range(options['n_days'] // 2):
      options['day'] = i+1
      X_data, y_data = get_X_y_S1_S2(X_days, y_days, **options)

      data = circcvl(np.nanmean(X_data[:size, idx], 0), windowSize=10, axis=0)

      ax[0][i].imshow(data,
                      aspect='auto', cmap='jet',
                      extent=[0, 14, 0, 693],
                      vmin=-0.5, vmax=1.5,
                      )

      add_vlines(ax=ax[0][i])
      add_vlines(ax=ax[0][i])
      add_vlines(ax=ax[0][i])

  for i in range(options['n_days'] // 2, options['n_days']):
      options['day'] = i+1
      X_data, y_data = get_X_y_S1_S2(X_days, y_days, **options)

      data = circcvl(np.nanmean(X_data[:size, idx], 0), windowSize=10, axis=0)
      ax[1][i-3].imshow(data,
                        aspect='auto', cmap='jet',
                        extent=[0, 14, 0, 693],
                        vmin=-0.5, vmax=1.5,
                      )
      add_vlines(ax=ax[1][i-3])
      add_vlines(ax=ax[1][i-3])
      add_vlines(ax=ax[1][i-3])
  plt.show()
#+end_src

#+RESULTS:
:RESULTS:
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 1 LASER 0
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 2 LASER 0
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 3 LASER 0
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 4 LASER 0
: DATA: FEATURES sample TASK DPA TRIALS  DAYS 5 LASER 0
[[file:./.ob-jupyter/4b4e4167916aef7828483f297a53c40c09e94c45.png]]
:END:

* Data

#+begin_src ipython
  X_days, y_days = get_X_y_days(**options)
  y_days['tasks'] = y_days['tasks'].astype('category')
  # y_days = y_days[y_days['laser']==0]

  options['day'] = 1
  X_data, y_data = get_X_y_S1_S2(X_days, y_days, **options)
#+end_src

#+RESULTS:
#+begin_example
  Reading data from source file
  mouse JawsM15 n_days 6 day 1 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 2 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 3 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 4 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 5 type dF all data: X (192, 693, 84) y (9, 192)
  mouse JawsM15 n_days 6 day 6 type dF all data: X (192, 693, 84) y (9, 192)
  ##########################################
  PREPROCESSING: SCALER None AVG MEAN False AVG NOISE True UNIT VAR False
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 1 LASER 0
#+end_example

  #+begin_src ipython
  plt.plot(X_data[:10, 1].T, alpha=.5)
  plt.show()
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/18c1919442723cfcc0b6bc34b542eb35c8041ca7.png]]

* GLM

#+begin_src ipython
  import statsmodels.api as sm
  import statsmodels.formula.api as smf
  import pandas as pd
#+end_src

#+RESULTS:

#+begin_src ipython
  print(X_days.shape, y_days.shape)
#+end_src

#+RESULTS:
: (1152, 693, 84) (1152, 6)

#+begin_src ipython
  print(y_days.keys())
#+end_src

#+RESULTS:
: Index(['sample_odor', 'test_odor', 'response', 'tasks', 'laser', 'day'], dtype='object')

#+begin_src ipython
  print(X_data.shape, y_data.shape)
#+end_src

#+RESULTS:
: (32, 693, 84) (32,)

#+begin_src ipython
  print(X_days.shape)
#+end_src

#+RESULTS:
: (1152, 693, 84)

#+begin_src ipython
  data = y_days

  options['epochs'] = ['ED']
  X_avg = avg_epochs(X_days, **options).astype('float32')
  print(X_avg.shape)

  data['df'] = X_avg[:, 0]
  data['tasks'] = data['tasks'].astype('category')
  print(data.keys())
#+end_src

#+RESULTS:
: (1152, 693)
: Index(['sample_odor', 'test_odor', 'response', 'tasks', 'laser', 'day', 'df'], dtype='object')

#+begin_src ipython
  print(data['tasks'].head())
#+end_src

#+RESULTS:
: 0    DualNoGo
: 1    DualNoGo
: 2      DualGo
: 3      DualGo
: 4    DualNoGo
: Name: tasks, dtype: category
: Categories (3, object): ['DPA', 'DualGo', 'DualNoGo']

#+begin_src ipython
  #  Specify the formula
  formula = 'df ~ sample_odor * tasks'
#+end_src

#+RESULTS:

#+begin_src ipython
  results = []
  for neuron in range(X_avg.shape[1]):
      data['df'] = X_avg[:, neuron]
      glm_gauss = smf.glm(formula=formula, data=data, family=sm.families.Poisson(link=sm.families.links.log()))
      # glm_gauss = smf.glm(formula=formula, data=data, family=sm.families.Gaussian())
      results.append(glm_gauss.fit())
#+end_src

#+RESULTS:

#+begin_src ipython
  #  Output the summary of the model
  print(results[3].summary())
#+end_src

#+RESULTS:
#+begin_example
                   Generalized Linear Model Regression Results
  ==============================================================================
  Dep. Variable:                     df   No. Observations:                 1152
  Model:                            GLM   Df Residuals:                     1146
  Model Family:                 Poisson   Df Model:                            5
  Link Function:                    log   Scale:                          1.0000
  Method:                          IRLS   Log-Likelihood:                -92.189
  Date:                Mon, 15 Jul 2024   Deviance:                       78.499
  Time:                        17:45:21   Pearson chi2:                     231.
  No. Iterations:                     6   Pseudo R-squ. (CS):          0.0005789
  Covariance Type:            nonrobust
  =================================================================================================
                                      coef    std err          z      P>|z|      [0.025      0.975]
  -------------------------------------------------------------------------------------------------
  Intercept                        -4.0236      0.540     -7.457      0.000      -5.081      -2.966
  tasks[T.DualGo]                   0.0967      0.745      0.130      0.897      -1.364       1.557
  tasks[T.DualNoGo]                 0.1371      0.738      0.186      0.853      -1.310       1.584
  sample_odor                      -0.4792      0.873     -0.549      0.583      -2.189       1.231
  sample_odor:tasks[T.DualGo]       0.3606      1.150      0.313      0.754      -1.894       2.615
  sample_odor:tasks[T.DualNoGo]     0.3045      1.148      0.265      0.791      -1.945       2.554
  =================================================================================================
#+end_example

#+begin_src ipython
  selective_neuron = []
  for neuron in range(X_avg.shape[1]):
      p_value = results[neuron].pvalues['sample_odor']
      if p_value < 0.05:
          selective_neuron.append(neuron)
#+end_src

#+RESULTS:

#+begin_src ipython
  print(selective_neuron)
#+end_src

#+RESULTS:
: [17, 169, 317, 372, 460, 464, 516, 560, 647]

* Fluorescence

#+begin_src ipython
  x_time =  np.linspace(0, 14, 84)
#+end_src

#+RESULTS:

#+begin_src ipython
  # plt.imshow(X_data.mean(1), aspect='auto', cmap='viridis', extent=[0, 14, 0, 30])
  plt.imshow(np.nanmean(X_days, 0), aspect='auto', cmap='jet', extent=[0, 14, 0, 1152], vmax=0.1)

  cb = plt.colorbar()
  cb.set_label('$\Delta F / F$')

  plt.xticks(np.arange(0, 16, 2))
  plt.xlabel('Time')
  plt.ylabel('$\Delta F/F$')
  plt.ylabel('Trial')
  plt.show()
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/22de8b0a6fc9e81afc0e6d3b936fe3cd274ff4f1.png]]
