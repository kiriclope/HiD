#+TITLE: Bump in the Dual Task
#+STARTUP: fold
#+PROPERTY: header-args:ipython :results both :exports both :async yes :session dual_data :kernel dual_data

* Notebook Settings
#+begin_src ipython
  %load_ext autoreload
  %autoreload 2
  %reload_ext autoreload

  %run /home/leon/dual_task/dual_data/notebooks/setup.py
  %matplotlib inline
  %config InlineBackend.figure_format = 'png'
#+end_src

#+RESULTS:
: The autoreload extension is already loaded. To reload it, use:
:   %reload_ext autoreload
: Python exe
: /home/leon/mambaforge/envs/dual_data/bin/python

* Imports
#+begin_src ipython
  import sys
  sys.path.insert(0, '../')
  import pickle as pkl
  import numpy as np
  import matplotlib.pyplot as plt
  from scipy.stats import circmean

  from dual_data.common.fig_grid import create_grid
  from dual_data.overlap.get_cos import run_get_cos, plot_bump
  from dual_data.attractor.energy import run_energy, plot_energy 
  from dual_data.stats.bootstrap import my_boots_ci
  from dual_data.decode.bump import decode_bump, circcvl  
  from dual_data.preprocess.helpers import preprocess_X
  from dual_data.common.options import set_options
#+end_src

#+RESULTS:

* Bump
** Parameters
#+begin_src ipython
  tasks = ['DPA', 'DualGo', 'DualNoGo']
  days = ['first', 'last']
  
  kwargs = dict()
  kwargs = {'prescreen': None, 'pval': 0.05, 'trials': '', 'balance': 'under', 'laser':0,
            'method': 'bootstrap',
            'bolasso_pval':0.05, 'bolasso_penalty': 'l2',
            'bootstrap':False, 'n_boots': 1000,
            'preprocess': True, 'scaler_BL':'robust',
            'avg_noise': True, 'unit_var_BL':False,
            'clf': 'log_loss', 'scaler': None,
            'tol':0.0001, 'penalty':'l1',
            'class_weight': None,
            'out_fold': 'stratified', 'random_state': None,
            'in_fold': 'stratified', 'n_in': 5,
            'n_repeats': 10,
            'n_lambda': 10,
            }

  time = np.linspace(0, 14, int(6 * 14))
#+end_src

#+RESULTS:

** Single mouse

#+begin_src ipython
  mouse = 'JawsM15'
  kwargs['reload']= False
  kwargs['data_type'] = 'raw'
#+end_src

#+RESULTS:

*** Locations on the Ring
#+begin_src ipython  
  day = 'first'
  X_df, y_df, X_first, y_first, theta_first = run_get_cos(mouse=mouse, day=day, **kwargs)
  
  day = 'last'
  kwargs['reload']= False 
  X_dl, y_dl, X_last, y_last, theta_last = run_get_cos(mouse=mouse, day=day, **kwargs)
#+end_src

#+RESULTS:
#+begin_example
  loading files from /home/leon/dual_task/dual_data/data/JawsM15
  X_days (1152, 693, 84) y_days (1152, 6)
  ##########################################
  PREPROCESSING: SCALER robust AVG MEAN 0 AVG NOISE True UNIT VAR False
  ##########################################
  in_fold stratified
  ##########################################
  MODEL: RESAMPLE under SCALER None PRESCREEN None PCA False METHOD bootstrap FOLDS stratified CLF log_loss
  ##########################################
  DATA: FEATURES distractor TASK Dual TRIALS correct DAYS first LASER 0
  ##########################################
  multiple days 0 3 0
  X_S1 (55, 693, 84) X_S2 (70, 693, 84)
  Distractor: X (125, 693) y (125,)
  non_zeros 344
  ##########################################
  DATA: FEATURES sample TASK Dual TRIALS correct DAYS first LASER 0
  ##########################################
  multiple days 0 3 0
  X_S1 (60, 693, 84) X_S2 (65, 693, 84)
  Sample: X (125, 693) y (125,)
  non_zeros 338
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS first LASER 0
  ##########################################
  multiple days 0 3 0
  X_S1 (48, 693, 84) X_S2 (48, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 1 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 2 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 3 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 4 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 5 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 1 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 2 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 3 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 4 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 5 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 1 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 2 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 3 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 4 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 5 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  Done
  loading files from /home/leon/dual_task/dual_data/data/JawsM15
  X_days (1152, 693, 84) y_days (1152, 6)
  ##########################################
  PREPROCESSING: SCALER robust AVG MEAN 0 AVG NOISE True UNIT VAR False
  ##########################################
  in_fold stratified
  ##########################################
  MODEL: RESAMPLE under SCALER None PRESCREEN None PCA False METHOD bootstrap FOLDS stratified CLF log_loss
  ##########################################
  DATA: FEATURES distractor TASK Dual TRIALS correct DAYS last LASER 0
  ##########################################
  multiple days 0 3 0
  X_S1 (78, 693, 84) X_S2 (82, 693, 84)
  Distractor: X (160, 693) y (160,)
  non_zeros 343
  ##########################################
  DATA: FEATURES sample TASK Dual TRIALS correct DAYS last LASER 0
  ##########################################
  multiple days 0 3 0
  X_S1 (79, 693, 84) X_S2 (81, 693, 84)
  Sample: X (160, 693) y (160,)
  non_zeros 315
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS last LASER 0
  ##########################################
  multiple days 0 3 0
  X_S1 (48, 693, 84) X_S2 (48, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 1 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 2 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 3 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 4 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 5 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DPA TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 1 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 2 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 3 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 4 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 5 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualGo TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 1 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 2 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 3 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 4 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 5 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  ##########################################
  DATA: FEATURES sample TASK DualNoGo TRIALS  DAYS 6 LASER 0
  ##########################################
  single day
  X_S1 (16, 693, 84) X_S2 (16, 693, 84)
  Done
#+end_example

*** Plot Bumps

#+begin_src ipython
  X_norm = X_first[1]
  # X_norm = preprocess_X(X, scaler="robust", avg_noise=0, unit_var=0)
  plot_bump(X_norm, y_first[1], 'all', int(X_first[0].shape[1] * .1))
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/31cb6d56685948f6bfcccb2e6e73df074facdde6.png]]

#+begin_src ipython
  X_norm = X_last[2]
  # X_norm = preprocess_X(X, scaler="robust", avg_noise=0, unit_var=0)
  plot_bump(X_norm, y_last[2], 'all', int(X_last[0].shape[1] * .1))
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/0807185a930e711e10072ad98699b52daec6043c.png]]
 
*** Save Data
#+begin_src ipython
  import pickle as pkl
  filename = "../data/" + mouse + "/X_bump_first_" + kwargs['penalty'] + ".pkl"
  pkl.dump(X_first, open(filename + ".pkl", "wb"))

  filename = "../data/" + mouse + "/y_bump_first_" + kwargs['penalty'] + ".pkl"
  pkl.dump(y_first, open(filename + ".pkl", "wb"))

  filename = "../data/" + mouse + "/X_bump_last_" + kwargs['penalty'] + ".pkl"
  pkl.dump(X_last, open(filename + ".pkl", "wb"))

  filename = "../data/" + mouse + "/y_bump_last_" + kwargs['penalty'] + ".pkl"
  pkl.dump(y_last, open(filename + ".pkl", "wb")) 
#+end_src

#+RESULTS:
:RESULTS:
# [goto error]
: [0;31m---------------------------------------------------------------------------[0m
: [0;31mNameError[0m                                 Traceback (most recent call last)
: Cell [0;32mIn[201], line 3[0m
: [1;32m      1[0m [38;5;28;01mimport[39;00m [38;5;21;01mpickle[39;00m [38;5;28;01mas[39;00m [38;5;21;01mpkl[39;00m
: [1;32m      2[0m filename [38;5;241m=[39m [38;5;124m"[39m[38;5;124m../data/[39m[38;5;124m"[39m [38;5;241m+[39m mouse [38;5;241m+[39m [38;5;124m"[39m[38;5;124m/X_bump_first_[39m[38;5;124m"[39m [38;5;241m+[39m kwargs[[38;5;124m'[39m[38;5;124mpenalty[39m[38;5;124m'[39m] [38;5;241m+[39m [38;5;124m"[39m[38;5;124m.pkl[39m[38;5;124m"[39m
: [0;32m----> 3[0m pkl[38;5;241m.[39mdump([43mX_first[49m, [38;5;28mopen[39m(filename [38;5;241m+[39m [38;5;124m"[39m[38;5;124m.pkl[39m[38;5;124m"[39m, [38;5;124m"[39m[38;5;124mwb[39m[38;5;124m"[39m))
: [1;32m      5[0m filename [38;5;241m=[39m [38;5;124m"[39m[38;5;124m../data/[39m[38;5;124m"[39m [38;5;241m+[39m mouse [38;5;241m+[39m [38;5;124m"[39m[38;5;124m/y_bump_first_[39m[38;5;124m"[39m [38;5;241m+[39m kwargs[[38;5;124m'[39m[38;5;124mpenalty[39m[38;5;124m'[39m] [38;5;241m+[39m [38;5;124m"[39m[38;5;124m.pkl[39m[38;5;124m"[39m
: [1;32m      6[0m pkl[38;5;241m.[39mdump(y_first, [38;5;28mopen[39m(filename [38;5;241m+[39m [38;5;124m"[39m[38;5;124m.pkl[39m[38;5;124m"[39m, [38;5;124m"[39m[38;5;124mwb[39m[38;5;124m"[39m))
: 
: [0;31mNameError[0m: name 'X_first' is not defined
:END:
*** Load Data
#+begin_src ipython
  filename = "../data/" + mouse + "/X_bump_first_" + kwargs['penalty'] + ".pkl"
  X_first = pkl.load(open(filename + ".pkl", "rb"))

  filename = "../data/" + mouse + "/y_bump_first_" + kwargs['penalty'] + ".pkl"
  y_first = pkl.load(open(filename + ".pkl", "rb"))

  filename = "../data/" + mouse + "/X_bump_last_" + kwargs['penalty'] + ".pkl"
  X_last = pkl.load(open(filename + ".pkl", "rb"))

  filename = "../data/" + mouse + "/y_bump_last_" + kwargs['penalty'] + ".pkl"
  y_last = pkl.load(open(filename + ".pkl", "rb")) 
#+end_src

#+RESULTS:

* Energy Landscape
#+begin_src ipython
  opts = set_options(mouse=mouse, T_WINDOW=0.0)
  
  #bins = np.concatenate( (opts['bins_ED'], opts['bins_MD'], opts['bins_LD'], opts['bins_CHOICE']))
  # bins = np.concatenate( (opts['bins_BL'], opts['bins_ED'], opts['bins_MD'], opts['bins_LD']))
  bins = np.concatenate( (opts['bins_BL'], opts['bins_STIM'], opts['bins_ED'], opts['bins_MD'], opts['bins_LD']))
  # bins = np.concatenate( (opts['bins_BL'], opts['bins_ED'], opts['bins_MD']))
  # bins = np.concatenate( (opts['bins_MD'], opts['bins_LD']))
 #+end_src

#+RESULTS:

** Parameters
#+begin_src ipython
  task = 13

  # n_bins = 200
  # max_num_bins = len(bins)
  # num_bins = np.min((n_bins, max_num_bins))

  num_bins = int(0.25 * X_first[0].shape[1])
  num_bins = 200
  print('num_bins', num_bins)

  window = 0.1
  print('window', window)

  IF_HMM = 0
  n_iter = 10

  IF_BOOT=0
  IF_NORM=0
#+end_src

#+RESULTS:
: num_bins 200
: window 0.1

** Compute Energy
#+begin_src ipython
  if task=='all':
      X = np.vstack(X_first)
  elif task==13:
      X = np.vstack((X_first[0], X_first[-1]))
  else:
      X = X_first[task]

  if IF_NORM:
      X = preprocess_X(X, scaler="robust", avg_noise=0, unit_var=0)

  X = X[..., bins]
  
  ci_first = None
  energy_first = run_energy(X, num_bins, window, VERBOSE=0, IF_HMM=IF_HMM, n_iter=n_iter)
  if IF_BOOT:
      _, ci_first = my_boots_ci(X, lambda x: run_energy(x, num_bins, window, IF_HMM=IF_HMM), n_samples=1000)
  # print(energy_first)
#+end_src

#+RESULTS:

#+RESULTS:
: (124, 693, 84)

#+begin_src ipython
  if task=='all':
      X = np.vstack(X_last)
  elif task==13:
      X = np.vstack((X_last[0], X_last[-1]))
  else:
      X = X_last[task]

  if IF_NORM:
      X = preprocess_X(X, scaler="robust", avg_noise=0, unit_var=0)

  X = X[..., bins]
  
  ci_last = None
  energy_last = run_energy(X, num_bins, window, VERBOSE=0, IF_HMM=IF_HMM, n_iter=n_iter)
  if IF_BOOT:
      _, ci_last = my_boots_ci(X, lambda x: run_energy(x, num_bins, window, IF_HMM=IF_HMM), n_samples=1000)
  #  print(energy_last)
#+end_src

#+RESULTS:

#+begin_src ipython
  fig, ax = plt.subplots()
  SMOOTH = 1
  window = .1

  plot_energy(energy_first,  ci=ci_first, ax=ax, window=window, SMOOTH=SMOOTH, color='b')
  plot_energy(energy_last, ci=ci_last, ax=ax, window=window, SMOOTH=SMOOTH, color='r')
  # plt.ylim([0, .2])
  # plt.xlim([0, 270])
  plt.savefig("../figs/landscape/"+ mouse + "_" + str(task) + '_trials_' + kwargs['penalty'] + '.svg', dpi=300)

  plt.show()
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/54c4b8b20440b6591b971c2e4fde42804ffa10d3.png]]

* model

#+begin_src ipython
  REPO_ROOT = "/home/leon/models/NeuroTorch"

  def get_rates_ini_phi(name, ini_list, phi_list):
    rates_list = []
    for ini in ini_list:
      for phi in phi_list:
        rates = np.load(REPO_ROOT + '/data/simul/%s_ini_%d_phi_%d.npy' % (name, ini, phi))
        rates_list.append(rates)

    rates_list = np.array(rates_list).reshape(len(ini_list), len(phi_list), rates.shape[0], rates.shape[1])
    print(rates_list.shape)
    return rates_list  
#+end_src

#+RESULTS:

#+begin_src ipython
  ini_list = np.arange(0, 10)
  # phi_list = np.linspace(0, 315, 8)
  phi_list = [0, 180]

  rates = get_rates_ini_phi('lowR_ortho', ini_list, phi_list)
  rates_heter = get_rates_ini_phi('heter_10', ini_list, phi_list)
#+end_src

#+RESULTS:
: (10, 2, 15, 10000)
: (10, 2, 8499, 1000)

#+begin_src ipython
  X = np.vstack(rates)
  X = np.swapaxes(X, 1, -1)
  X = X[:, :7500]
  print(X.shape)
#+end_src

#+RESULTS:
: (20, 7500, 15)

#+begin_src ipython
  X_heter = np.vstack(rates_heter)
  X_heter = np.swapaxes(X_heter, 1, -1)
#+end_src

#+RESULTS:

#+begin_src ipython
  _, phase = decode_bump(X, axis=1)
  print(phase.shape)
#+end_src

#+RESULTS:
: (20, 15)

#+begin_src ipython
  for i in range(10):
      plt.plot(phase[i] * 180 / np.pi, alpha=.2)
      plt.plot(phase[-i] * 180 / np.pi, alpha=.2)
  plt.show()
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/03e8fbf5fb7a44a07f6644f71d3c036d354e36c7.png]]

#+begin_src ipython
  num_bins = 200
  window = 0
  energy1 = run_energy(X[..., :2500], num_bins, window)
  energy2 = run_energy(X_heter[..., :2500], num_bins, window)
#+end_src

#+RESULTS:

#+begin_src ipython
  fig, ax = plt.subplots()
  SMOOTH = 1
  window = .1

  plot_energy(energy2,  ax=ax, window=window,
              SMOOTH=SMOOTH, color='b')
  
  plot_energy(energy1,  ax=ax, window=window,
              SMOOTH=SMOOTH, color='r')
  plt.show()
#+end_src

#+RESULTS:
[[file:./.ob-jupyter/1bfd1a87206d4ece183ce90e480fb45cd0cc47d2.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

*** random
#+begin_src ipython
  mice = ['ChRM04','JawsM15', 'JawsM18', 'ACCM03', 'ACCM04']
  
  def figname(mouse):
      return mouse + "_behavior_tasks_correct" + ".svg"

  figlist = ['../figs/landscape' + figname(mouse) for mouse in mice]
  print(figlist)

  golden_ratio = (5**.5 - 1) / 2
  width = 4.3
  height = width * golden_ratio * 1.4
  figsize = [width, height]
  matplotlib.rcParams['lines.markersize'] = 5.5

  create_grid(figlist, "../figs/performance_all_mice.svg", dim=[4,3], fontsize=22)

#+end_src

#+RESULTS:
:RESULTS:
: ['../figs/landscapeChRM04_behavior_tasks_correct.svg', '../figs/landscapeJawsM15_behavior_tasks_correct.svg', '../figs/landscapeJawsM18_behavior_tasks_correct.svg', '../figs/landscapeACCM03_behavior_tasks_correct.svg', '../figs/landscapeACCM04_behavior_tasks_correct.svg']
# [goto error]
: [0;31m---------------------------------------------------------------------------[0m
: [0;31mNameError[0m                                 Traceback (most recent call last)
: Cell [0;32mIn[150], line 13[0m
: [1;32m     11[0m height [38;5;241m=[39m width [38;5;241m*[39m golden_ratio [38;5;241m*[39m [38;5;241m1.4[39m
: [1;32m     12[0m figsize [38;5;241m=[39m [width, height]
: [0;32m---> 13[0m [43mmatplotlib[49m[38;5;241m.[39mrcParams[[38;5;124m'[39m[38;5;124mlines.markersize[39m[38;5;124m'[39m] [38;5;241m=[39m [38;5;241m5.5[39m
: [1;32m     15[0m create_grid(figlist, [38;5;124m"[39m[38;5;124m../figs/performance_all_mice.svg[39m[38;5;124m"[39m, dim[38;5;241m=[39m[[38;5;241m4[39m,[38;5;241m3[39m], fontsize[38;5;241m=[39m[38;5;241m22[39m)
: 
: [0;31mNameError[0m: name 'matplotlib' is not defined
:END:

#+begin_src ipython
  def find_extrema(values, window, bins):

    search_space = np.linspace(0, 360, values.shape[0], endpoint=False)

    values = values[(search_space>=bins[0]) & (search_space<=bins[1])]
    search_space = search_space[(search_space>=bins[0]) & (search_space<=bins[1])]
    
    min_index = np.argmin(values)
    max_index = np.argmax(values)

    # Find the global minimum and maximum values (well depth and barrier top height)
    well_depth = values[min_index]
    barrier_top_height = values[max_index]

    # Find the location of the well and barrier top
    well_location = search_space[min_index]
    barrier_top_location = search_space[max_index]
    print('well:','location', well_location, 'size', well_depth,
          'barrier_top', 'location', barrier_top_location, 'size', barrier_top_height)

    # search_space = np.linspace(0, 360, values.shape[0], endpoint=False)
    # min_idx = np.argwhere(search_space == well_location)
    # max_idx = np.argwhere(search_space == barrier_top_location)

    return min_index, max_index, well_depth, barrier_top_height
#+end_src

#+RESULTS:

#+begin_src ipython
  windowSize = int(window * energy_first.shape[0])
  values = circcvl(energy_last, windowSize) * 100
  min, max , depth , high = find_extrema(values, window, bins=[0, 90])
  min, max , depth , high = find_extrema(values, window, bins=[90, 180])
  min, max , depth , high = find_extrema(values, window, bins=[180, 270])
  min, max , depth , high = find_extrema(values, window, bins=[270, 360])  
#+end_src

#+RESULTS:
: well: location 8.0 size 0.17327824249577137 barrier_top location 88.0 size 0.27469014326503216
: well: location 180.0 size 0.08262227261666122 barrier_top location 104.0 size 0.2917498066774323
: well: location 188.0 size 0.07131802872762201 barrier_top location 256.0 size 0.3325591506835605
: well: location 356.0 size 0.1856840421862889 barrier_top location 276.0 size 0.3360528835608969

#+begin_src ipython
  E_copy = np.delete(values, min)
  min2, max2 , depth , high = find_extrema(E_copy, window, bins=[0, 200])  
#+end_src

#+RESULTS:
: well: location 188.0 size 0.0005612652365147334 barrier_top location 84.0 size 0.002771244370013652

#+begin_src ipython
  def find_local_extrema(energy, window, epsilon=1e-5):

      window = int(window * energy.shape[0])
      values = circcvl(energy, windowSize=window)
      min_index = np.argmin(values)
      max_index = np.argmax(values)

      search_space = np.linspace(0, 360, energy.shape[0], endpoint=False)
      # Evaluate the landscape over the search space

      # Prepare lists to hold the points of detected extrema
      minima = []
      maxima = []

      # Iterate over the evaluated points and look for sign changes
      for i in range(1, len(values) - 1):
          # Check for a local minimum
          if values[i] < values[i - 1] and values[i] < values[i + 1]:
              minima.append((search_space[i], values[i]))

          # Check for a local maximum
          if values[i] > values[i - 1] and values[i] > values[i + 1]:
              maxima.append((search_space[i], values[i]))

      # Filter extrema to remove very close points (within epsilon)
      minima = [(x, y) for i, (x, y) in enumerate(minima)
                if i == 0 or (i > 0 and abs(x - minima[i-1][0]) > epsilon)]
      maxima = [(x, y) for i, (x, y) in enumerate(maxima)
                if i == 0 or (i > 0 and abs(x - maxima[i-1][0]) > epsilon)]

      # Return the detected extrema
      return {
          'wells': minima,
          'barrier_tops': maxima
      }

#+end_src

#+RESULTS:

#+begin_src ipython
  find_local_extrema(energy_first, window)
#+end_src

#+RESULTS:
| wells | : | ((16.0 0.0015743827021504088) (64.0 0.002395353937104354) (88.0 0.0026713243917297074) (96.0 0.002701233453606301) (188.0 0.0005612652365147334) (272.0 0.003094561390032623) (336.0 0.0011888204077842568) (344.0 0.0012699695810135545)) | barrier_tops | : | ((12.0 0.0016178249836610833) (60.0 0.002417496788466346) (84.0 0.002771244370013652) (92.0 0.0027215515464872474) (104.0 0.0027423902055076104) (268.0 0.0031169150432897906) (280.0 0.003119171330146179) (340.0 0.0012875979045408605)) |

#+begin_src ipython
  def get_energy(X, num_bins, bins, IF_NORM=0, IF_CI=0):
      if IF_NORM:
          X = preprocess_X(X, scaler="robust", avg_noise=0, unit_var=0)

      X = X[..., bins[0]:bins[1]]

      ci_last = None
      energy = run_energy(X, num_bins, window=0)

      return energy
#+end_src

#+begin_src ipython
  def get_min_max(energy, window):
      smooth = circcvl(energy, windowSize=window)

      min = np.min(smooth)
      max = np.max(smooth)
#+end_src

#+RESULTS:

#+begin_src ipython
from scipy.signal import argrelextrema
from scipy.optimize import minimize_scalar

def find_landscape_features(landscape_function, x_start, x_end):
    # Create a grid of points between x_start and x_end
    x = np.linspace(x_start, x_end, num_points)
    # Evaluate the landscape function on this grid
    y = landscape_function(x)

    # Find indices of local maxima and minima
    maxima_indices = argrelextrema(y, np.greater)[0]
    minima_indices = argrelextrema(y, np.less)[0]
    
    # Use minimize_scalar to refine the location of the wells and barrier tops
    wells = []
    for index in minima_indices:
        result = minimize_scalar(lambda x: landscape_function(x), bracket=[x[index-1], x[index], x[index+1]])
        wells.append((result.x, result.fun))

    barrier_tops = []
    for index in maxima_indices:
        result = minimize_scalar(lambda x: -landscape_function(x), bracket=[x[index-1], x[index], x[index+1]])
        barrier_tops.append((result.x, -result.fun))

    return wells, barrier_tops

#+end_src

#+begin_src ipython
  for i_day in days:
    
#+end_src
